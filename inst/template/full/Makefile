# Change the word USER by your DockerHub username
DOCKERHUB_USERNAME := USER

# variables for R
R := Rscript -e
RMD_TEXT := main-script.Rmd
DOCX := manuscript/manuscript.docx
RMD_CODE := R/analysis.Rmd
HTML := output/results/analysis.html

# variables for Docker
PROJECT_NAME := $(shell basename "$(PWD)")
DOCKER_IMAGE := $(DOCKERHUB_USERNAME)/$(PROJECT_NAME)

# commands (rules)
styler: ## format the code of RMD_TEXT and RMD_CODE
	$(R) "styler::style_file('$(RMD_TEXT)')"
	$(R) "styler::style_file('$(RMD_CODE)')"

.PHONY: manuscript
manuscript: ## compile RMD_TEXT as DOCX
	$(R) "rmarkdown::render( \
	input = '$(RMD_TEXT)', \
	output_file = '$(DOCX)' \
	)"

.PHONY: analysis
analysis: ## compile RMD_CODE as HTML
	$(R) "rmarkdown::render( \
	input = '$(RMD_CODE)', \
	params = list(show_results = TRUE), \
	output_file = '$(HTML)' \
	)"

.PHONY: clean_cache
clean_cache: ## remove cache generated by RMD_TEXT and RMD_CODE
	rm -rf $(addsuffix _cache, $(basename $(RMD_TEXT)))
	rm -rf $(addsuffix _cache, $(basename $(RMD_CODE)))

docker_build: ## build DOCKER_IMAGE
	docker build -t $(DOCKER_IMAGE) .

docker_run: ## run DOCKER_IMAGE and get a copy of DOCX
	@echo "You need to run: docker run --rm -v `pwd`:/rendered chapter-01"
	docker run --rm -v `pwd`:/rendered $(DOCKER_IMAGE)

docker_push:  ## push DOCKER_IMAGE to DockerHub
	docker push $(DOCKER_IMAGE)

all: clean_cache analysis manuscript ## run clean_cache, analysis, and manuscript commands

.DEFAULT_GOAL := help
help: ## show this message
	@echo "--------VARIABLES--------------------------------------------------------"
	@printf "\033[36mPROJECT_NAME\033[0m         $(PROJECT_NAME) \n"
	@printf "\033[36mDOCKERHUB_USERNAME\033[0m   $(DOCKERHUB_USERNAME) \n"
	@printf "\033[36mDOCKER_IMAGE\033[0m         $(DOCKER_IMAGE) \n"
	@printf "\033[36mRMD_TEXT\033[0m             $(RMD_TEXT) \n"
	@printf "\033[36mRMD_CODE\033[0m             $(RMD_CODE) \n"
	@printf "\033[36mDOCX\033[0m                 $(DOCX) \n"
	@printf "\033[36mHTML\033[0m                 $(HTML) \n"
	@echo "--------COMMANDS---------------------------------------------------------"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo "-------------------------------------------------------------------------"
